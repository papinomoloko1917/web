<template>
    <div ref="contactBar"
        class="mobile-contact-bar lg:hidden w-full z-40 bg-[#FFFFFF] border-b border-gray-200 shadow-md"
        :class="[isSticky ? 'fixed top-0 shadow-lg' : 'relative']">
        <div class="container mx-auto px-4 py-1">
            <div class="flex items-center justify-between gap-4">
                <!-- Социальные иконки слева -->
                <div class="flex items-center gap-3">
                    <a :href="telegramUrl" target="_blank" rel="noopener noreferrer"
                        class="p-2 rounded-full bg-transparent text-gray-700" aria-label="Telegram">
                        <svg class="w-5 h-5 md:w-6 md:h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 191 174"
                            fill="currentColor">
                            <path
                                d="M186.4306 3.3645C183.2067 0.6297 178.143 0.2384 172.9073 2.3411C172.9044 2.3411 172.9016 2.3411 172.8987 2.3411C167.3923 4.5513 17.0286 69.0687 10.9074 71.7046C9.7941 72.0916 0.0708 75.7208 1.0723 83.8048C1.9664 91.0934 9.7812 94.112 10.7355 94.4603C23.4779 98.8248 36.2202 103.1893 48.9626 107.5538C51.4988 115.999 60.8481 147.1569 62.9157 153.8133C64.2053 157.9629 66.3073 163.4153 69.9912 164.5376C73.2237 165.7846 76.439 164.6451 78.5195 163.0111C86.3099 155.7827 94.1004 148.5544 101.8908 141.3261C114.4669 151.1373 127.0431 160.9485 139.6193 170.7597C139.9187 170.9389 140.2182 171.118 140.5177 171.2972C143.0796 172.4324 145.5341 173 147.8768 173C149.6865 173 151.4231 172.6603 153.0824 171.9809C158.735 169.6589 160.996 164.271 161.2324 163.6604C170.6262 114.8165 180.02 65.9727 189.4138 17.1289C191.1332 9.3028 188.7432 5.321 186.4306 3.3645ZM82.6762 112.7912C78.3777 124.2579 74.0791 135.7246 69.7805 147.1913C65.482 132.8579 61.1834 118.5246 56.8849 104.1912C89.8405 79.8245 122.7961 55.4577 155.7518 31.091C131.3932 58.3244 107.0347 85.5578 82.6762 112.7912Z" />
                        </svg>
                    </a>

                    <a :href="telegramMaxUrl" target="_blank" rel="noopener noreferrer"
                        class="p-2 rounded-full bg-transparent text-gray-700" aria-label="Max">
                        <svg class="w-5 h-5 md:w-6 md:h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 174.03 174"
                            fill="currentColor">
                            <path
                                d="M88.4263 152.0725C75.5231 152.0725 69.5267 150.1891 59.1037 142.6556C52.5108 151.1308 31.6333 157.754 30.7228 146.4223C30.7228 137.9157 28.8391 130.7275 26.7043 122.88C24.1613 113.212 21.273 102.4453 21.273 86.8446C21.273 49.585 51.8515 21.554 88.081 21.554C124.3419 21.554 152.7541 50.9662 152.7541 87.1899C152.8758 122.8535 124.0953 151.8822 88.4263 152.0725ZM88.96 53.7599C71.3162 52.8496 57.5653 65.0602 54.52 84.2079C52.0084 100.0597 56.4665 119.3644 60.2653 120.3689C62.0862 120.8083 66.6698 117.1043 69.5267 114.2479C74.2508 117.5108 79.7519 119.4706 85.4752 119.9294C103.7571 120.8086 119.3783 106.8928 120.6059 88.6338C121.3205 70.3363 107.2445 54.8383 88.96 53.7912C88.96 53.7808 88.96 53.7703 88.96 53.7599ZM110.1343 1C110.031 1 109.9278 1 109.8246 1C104.3599 1 98.8951 1 93.4304 1C83.5847 1 73.739 1 63.8933 1C12.0958 1 1.0001 12.1112 1.0001 63.8832C1.0001 79.2944 1.0001 94.7056 1.0001 110.1168C1.0001 161.906 12.113 173 63.8933 173C73.739 173 83.5847 173 93.4304 173C98.8951 173 104.3599 173 109.8246 173C109.9278 173 110.031 173 110.1343 173C161.9317 173 173.0275 161.8888 173.0275 110.1168C173.0275 94.7056 173.0275 79.2944 173.0275 63.8832C173.0275 12.094 161.9145 1 110.1343 1Z" />
                        </svg>
                    </a>

                    <a :href="whatsAppUrl" target="_blank" rel="noopener noreferrer"
                        class="p-2 rounded-full bg-transparent text-gray-700" aria-label="WhatsApp">
                        <svg class="w-5 h-5 md:w-6 md:h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 174 174"
                            role="img" aria-hidden="true">
                            <path fill="currentColor"
                                d="M86.9999 1C39.5804 1 1.0002 39.5804 1.0002 87C1.0002 101.807 4.8253 116.3671 12.0792 129.2148C8.4323 142.227 4.7854 155.2391 1.1385 168.2513C0.7796 169.5338 1.1273 170.9098 2.0546 171.8633C2.7688 172.5999 3.741 173 4.7393 173C5.0384 173 5.3413 172.9626 5.6367 172.8916C19.2172 169.5276 32.7976 166.1636 46.3781 162.7996C58.8182 169.4777 72.8286 173 86.9999 173C134.4194 173 172.9996 134.4197 172.9996 87C172.9996 39.5804 134.4194 1 86.9999 1ZM130.2615 117.3468C128.4218 122.4395 119.5975 127.0872 115.3574 127.7117C111.5509 128.2688 106.735 128.5081 101.4478 126.8479C98.2434 125.8384 94.1304 124.4997 88.862 122.2525C66.7152 112.8075 52.2523 90.7878 51.1455 89.3332C50.0425 87.8787 42.1305 77.5138 42.1305 66.7863C42.1305 56.0587 47.8326 50.7828 49.8592 48.5992C51.8858 46.4155 54.2751 45.8696 55.7484 45.8696C57.2216 45.8696 58.691 45.8883 59.981 45.9481C61.3383 46.0154 63.1593 45.4359 64.9503 49.691C66.79 54.0583 71.2059 64.7858 71.7518 65.8814C72.3052 66.9732 72.6716 68.2483 71.9387 69.7028C71.2059 71.1573 70.8394 72.0659 69.7327 73.341C68.6259 74.616 67.4144 76.1827 66.4198 77.1624C65.313 78.2505 64.1651 79.4283 65.4514 81.6119C66.7376 83.7956 71.1685 90.9336 77.7344 96.7143C86.1661 104.1402 93.2816 106.4435 95.4877 107.5353C97.6938 108.6271 98.9838 108.4439 100.27 106.9894C101.5563 105.5311 105.789 100.6217 107.2584 98.4418C108.7279 96.2618 110.2011 96.6208 112.2277 97.3499C114.2543 98.0753 125.109 103.3475 127.3151 104.4393C129.5211 105.5311 130.9944 106.0771 131.5477 106.9857C132.1011 107.8905 132.1011 112.2578 130.2615 117.3468Z" />
                        </svg>
                    </a>
                </div>

                <!-- Кнопка телефона справа -->
                <a :href="`tel:${tel}`" aria-label="Позвонить"
                    class="header-telephone font-semibold flex items-center gap-1 overflow-hidden text-gray-700 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 md:w-6 md:h-6 no-invert" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                    </svg>
                    <span class="font-montserrat inline-block text-base md:text-lg leading-none">{{ phone }}</span>
                </a>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'

const props = defineProps({
    phone: { type: String, default: '+7 (918) 254 71 47' },
    tel: { type: String, default: '+79182547147' },
    telegramUrl: { type: String, default: 'https://t.me/your_telegram' },
    telegramMaxUrl: { type: String, default: 'https://t.me/your_max' },
    whatsAppUrl: { type: String, default: 'https://wa.me/79182547147' }
})

const contactBar = ref(null)
const isSticky = ref(false)
const originalOffsetTop = ref(0)

const updateStickyState = () => {
    if (!contactBar.value) return

    // Получаем позицию элемента от верха документа
    const scrollY = window.scrollY || window.pageYOffset

    // Если прокрутили ниже изначальной позиции элемента - прилипаем к верху
    if (scrollY >= originalOffsetTop.value) {
        isSticky.value = true
    } else {
        isSticky.value = false
    }
}

const recalculatePosition = () => {
    if (!contactBar.value) return

    // Временно отключаем sticky, чтобы получить истинную позицию
    const wasSticky = isSticky.value
    isSticky.value = false

    // Ждем следующего кадра для пересчета
    requestAnimationFrame(() => {
        if (contactBar.value) {
            const rect = contactBar.value.getBoundingClientRect()
            const scrollY = window.scrollY || window.pageYOffset
            originalOffsetTop.value = rect.top + scrollY

            // Восстанавливаем состояние
            isSticky.value = wasSticky
            updateStickyState()
        }
    })
}

onMounted(() => {
    // Запоминаем изначальную позицию элемента относительно верха документа
    // Используем несколько попыток для надежности
    setTimeout(() => {
        recalculatePosition()
    }, 100)

    setTimeout(() => {
        recalculatePosition()
    }, 300)

    window.addEventListener('scroll', updateStickyState, { passive: true })
    window.addEventListener('resize', recalculatePosition, { passive: true })
})

onUnmounted(() => {
    window.removeEventListener('scroll', updateStickyState)
})
</script>

<style scoped>
@media (min-width: 1024px) {
    .mobile-contact-bar {
        display: none;
    }
}
</style>
